<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alpine Poll App</title>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  <script defer>



function app() {

  return {
    stage: "username",
    username: "",
    error: "",
    pollLink: "",
    copiedMsg: "",
    poll: null,
    pollId: "",
    votes: {},
    es: null,
    selectedOptions: [],
    newPoll: {
      username: "",
      title: "",
      voting_time: 60,
      options: [{ title: "", is_selected: false }],
      is_multi: false,
    },
init() {
// prefer hash (no server request), fallback to pathname
  const hash = (window.location.hash || "").replace(/^#/, "");
  const parts = window.location.pathname.split("/");
  const last = parts.pop() || parts.pop(); // handles trailing slash
  const uuid = hash || last;

  if (uuid && /^[0-9a-fA-F-]{36}$/.test(uuid)) {
    this.pollId = uuid;
    this.loadPoll(uuid);          // fetch poll & subscribe
    this.stage = "live_poll";
  }
},
    async submitUsername() {
      this.error = "";
      if (this.username.length < 3) return this.error = "Invalid username.";
      this.newPoll.username = this.username;
      this.stage = "create";
    },

    async createPoll() {
      this.error = "";
      try {
        const res = await fetch("http://127.0.0.1:8000/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.newPoll),
        });
        if (!res.ok) throw new Error(await res.text());
        const uuid = await res.text();
        this.pollId = uuid;
        this.pollLink = `http://127.0.0.1:8000/#${uuid}`;
        this.stage = "created";
      } catch (e) {
        this.error = e.message || "Poll creation failed.";
      }
    },

    async copyLink() {
      await navigator.clipboard.writeText(this.pollLink);
      this.copiedMsg = "Link copied!";
      setTimeout(() => this.copiedMsg = "", 2000);
    },

    async loadPoll(id) {
      try {
        const res = await fetch(`http://127.0.0.1:8000/poll/${id}`);
        if (!res.ok) throw new Error(await res.text());
        this.poll = await res.json();
        this.selectedOptions = [];
        this.stage = "live_poll";
        this.subscribeLive(id);
      } catch (e) {
        this.error = e.message;
      }
    },

    subscribeLive(id) {
      if (this.es) this.es.close();
      this.es = new EventSource(`http://127.0.0.1:8000/poll/${id}/live`);
      this.es.onmessage = (e) => {
        this.votes = JSON.parse(e.data);
      };
    },

    async vote() {
      try {
        const payload = {
          username: this.username,
          poll_id: this.pollId,
          selected_options: this.selectedOptions,
        };
        const res = await fetch("http://127.0.0.1:8000/poll", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(await res.text());
      } catch (e) {
        this.error = e.message;
      }
    },
  };
}
window.app = app;
document.addEventListener("alpine:init", () => {
  Alpine.data("app", window.app);
});

  </script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-6"
      x-data="app()" x-init="init()">
  <div class="bg-gray-800 p-6 rounded w-full max-w-md space-y-4">

    <!-- Username -->
    <div x-show="stage === 'username'">
      <form @submit.prevent="submitUsername" class="space-y-3">
        <h1 class="text-lg font-semibold">Enter Username</h1>
        <input x-model="username"
               placeholder="Username"
               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
        <button type="submit"
                class="w-full py-2 bg-indigo-600 rounded hover:opacity-90">Continue</button>
        <p x-text="error" class="text-red-400 text-sm"></p>
      </form>
    </div>

    <!-- Poll Creation -->
    <div x-show="stage === 'create'">
      <form @submit.prevent="createPoll" class="space-y-3">
        <h1 class="text-lg font-semibold">Create Poll</h1>
        <input x-model="newPoll.title" placeholder="Poll Title"
               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
        <input x-model.number="newPoll.voting_time" type="number" min="1"
               placeholder="Voting Time (sec)"
               class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded">
        <label class="flex items-center gap-2">
          <input type="checkbox" x-model="newPoll.is_multi" class="accent-indigo-500">
          Allow multiple selections
        </label>

<template x-for="(opt, i) in newPoll.options" :key="i">
  <div class="flex items-center gap-2">
    <input x-model="opt.title"
           placeholder="Option Title"
           class="flex-1 px-3 py-2 bg-gray-700 border border-gray-600 rounded">
    <input :type="newPoll.is_multi ? 'checkbox' : 'radio'"
           name="creatorSelection"
           x-model="opt.is_selected"
           :value="true"
           class="accent-indigo-500">
  </div>
</template>

        <button type="button" @click="newPoll.options.push({ title: '' })"
                class="text-sm text-indigo-400 hover:underline">+ Add Option</button>
        <button type="submit"
                class="w-full py-2 bg-green-600 rounded hover:opacity-90">Create Poll</button>
        <p x-text="error" class="text-red-400 text-sm"></p>
      </form>
    </div>

    <!-- Poll Created -->
    <div x-show="stage === 'created'">
      <h1 class="text-lg font-semibold mb-2">Poll Created!</h1>
      <p>Hereâ€™s your shareable link:</p>
      <div class="bg-gray-700 px-3 py-2 rounded mt-2 break-all">
        <span x-text="pollLink"></span>
      </div>
      <p class="text-sm text-gray-400 mt-2">Anyone with this link can vote.</p>
      <button @click="copyLink" class="mt-3 py-2 w-full bg-indigo-600 rounded hover:opacity-90">
        Copy Link
      </button>
      <p x-text="copiedMsg" class="text-green-400 text-sm"></p>
    </div>
<div x-show="stage === 'live_poll'">
  <template x-if="poll">
    <div>
      <h1 class="text-lg font-semibold mb-2" x-text="poll.title"></h1>
      <template x-for="opt in poll.options" :key="opt.id">
        <label class="flex items-center gap-2 mb-2">
          <input 
            :type="poll.is_multi ? 'checkbox' : 'radio'"
            name="vote"
            :value="opt.id"
            x-model="selectedOptions"
            class="accent-indigo-500"
          >
          <span x-text="opt.title"></span>
          <span class="ml-auto text-sm text-gray-400" x-text="votes[opt.id] || 0"></span>
        </label>
      </template>
      <button @click="vote" class="mt-3 py-2 w-full bg-green-600 rounded hover:opacity-90">
        Submit Vote
      </button>
      <p x-text="error" class="text-red-400 text-sm mt-2"></p>
    </div>
  </template>
</div>
  </div>
</body>
</html>
